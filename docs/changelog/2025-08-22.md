# Changelog — 2025-08-22

## GPU Offload (llama-cpp)

**Статус:** Сборка с CUDA 13.0 успешна, runtime offload не активен (supports_gpu_offload = False).

### Что сделано

- Установлен полный **CUDA Toolkit 13.0** (nvcc 13.0.48).
- Пересобран `llama-cpp-python==0.3.16` с флагами: `-DGGML_CUDA=on -DLLAMA_CUDA_F16=on -DCMAKE_CUDA_ARCHITECTURES=89 (SM89)`, генератор **Ninja**.
- Wheel успешно создан; в platlib присутствует `ggml-cuda.dll`.
- Проведена диагностика:
  - `llama_supports_gpu_offload()` → False
  - `ggml_cuda_init: failed to initialize CUDA: (null)` при импорте.
  - `nvidia-smi` сообщает: Driver Version 576.52, CUDA Version 12.9.
- Подтверждён mismatch: собран под Toolkit 13.0, драйвер экспонирует среду 12.9.
- Добавлен и использован однострочный reproducible build / диагностика.
- Обновлён провайдер (lazy import + добавление CUDA DLL путей) — исключены проблемы раннего импорта.
- Создан preflight-скрипт ранее (подтверждение DLL присутствия) — всё в порядке на файловом уровне.

### Наблюдения / Вывод

Основная и единственная текущая причина отсутствия GPU offload: **устаревший драйвер NVIDIA**, не поддерживающий CUDA 13 ABI. Библиотеки собираются успешно — проблема на этапе инициализации CUDA в рантайме (driver/runtime incompat). Повторные пересборки без обновления драйвера результата не изменят.

### Риски

- Задержка выполнения спринта пункты 10.3–10.6 (perf GPU) до обновления драйвера.
- Потенциальные артефакты от параллельного наличия Toolkit 12.1 (PATH порядок контролируем, но рекомендуется дальнейшая чистка после успешного запуска offload).

### Решения / План

1. Обновить драйвер NVIDIA до версии с поддержкой CUDA 13.x.
2. Перезагрузка и повторная быстрая проверка (`python -c "import llama_cpp as lc; print(lc.llama_supports_gpu_offload())"`).
3. Если True — запуск `scripts/perf_gpu_smoke.py` и фиксация `reports/perf_gpu_smoke.json`.
4. Замеры с разными `n_gpu_layers` (0 / 8 / 16 / auto) → временная таблица в `docs/ТЗ/Perf.md` (раздел GPU Scaling 10.4).
5. Тест длинного контекста (512 токенов) CPU vs GPU (10.5).
6. Обновление README + Perf summary (10.6).
7. Реализация aggregate perf скрипта (`scripts/perf_probe.py`) и интеграция лёгкого smoke в CI (10.7).

### Альтернативный временный обход (не выбран)

Сборка под Toolkit 12.1 (даст offload раньше, но противоречит цели использования актуального стека; отложено).

### Как это улучшает систему

Разблокировка GPU offload критична для снижения латентности, увеличения tokens/s и закладывает основу для: MoE, длинного контекста, будущих перф оптимизаций и SLA агентного цикла.

### Следующий триггер для обновления

Как только драйвер обновлён — выполнить шаги плана (лог изменений следующего дня зафиксирует фактические метрики).

---
