# Технологический стек

Только то, что даёт прямую ценность в текущем функциональном скоупе. Остальное отложено или заменено лёгкими альтернативами.

## Основные слои
| Слой | Выбор | Причина |
|------|-------|---------|
| API | FastAPI | Простота + WebSocket |
| Config / схемы | Pydantic | Валидация + env override |
| LLM Runtime | llama-cpp-python | Локально, GPU offload |
| Embeddings | bge-m3 | Качество RU/EN + multi-vector |
| Vector Store | Qdrant | Фильтры + payload, локальный бинарь |
| BM25 | rank-bm25 | Простая гибридизация |
| Storage structured | SQLite (WAL) | 1 файл, простые бэкапы |
| Scheduler | APScheduler | Локальные периодические задачи |
| Logs | structlog | Структурировано |
| Metrics | prometheus-client | Экспорт стандартных метрик |
| Tests | pytest | Дефакто стандарт |
| UI | React + Vite | Быстрый dev, минимальная сложность |

## Модели (кратко)
LLM: Qwen2.5 7B (основная), Llama 3.1 8B (контроль), phi-3.5-mini (fallback).
Embeddings: bge-m3 (основная), gte-small (быстрый черновик).
Emotion: небольшая DistilRoBERTa.
Audio: faster-whisper small/medium + Piper ru.
Подробности → см. «Модели ИИ».

## Конфигурация слоёв
Все параметры в configs/*.yaml + override ENV (MIA__SECTION__KEY). См. config design (отдельный документ).

## Приоритетный roadmap (MVP → +)
1. Core API + LLM + RAG (hybrid).
2. Emotion snapshot + injection в prompt.
3. Diary + nightly reflection.
4. Metrics/logs.
5. Voice (STT + TTS).

## Отложено / Не выбрано
| Технология | Почему не сейчас | Альтернатива |
|------------|------------------|--------------|
| LangChain | Избыточный слой абстракций | Своё узкое API |
| Weaviate / Pinecone | Облачный/сложнее деплой | Qdrant локально |
| Postgres | Сложнее миграции/оперирование | SQLite WAL |
| Ray / Dask | Нет heavy параллельных задач | asyncio + процессы |
| Fine-tuning LLM | Дорого и мало пользы early | Prompt + RAG |
| Triton serving | Нет HL throughput | llama.cpp |

## Наблюдаемость
Метрики: latency (p95), rag_hit@5, emotion_shift_count, insight_novelty_avg.
Логи: JSON, уровни INFO/ERROR + event_id.

## Безопасность / Приватность
PII scrub перед сохранением, optional encrypt (libsodium) для diary.
forget API (soft delete + reindex schedule).

## Скрипты & Dev
scripts/: run_dev.py, prewarm_embeddings.py, eval_rag.py
just (или simple invoke) для коротких команд.

## Производительность
Прогрев embedding модели при старте.
LLM context reuse (kv cache) для последовательных сообщений.
Кэш эмбеддингов diskcache/.

## Расширение
Модули через manifest.yaml (подписи событий, требуемые конфиги). См. «Архитектура проекта».
