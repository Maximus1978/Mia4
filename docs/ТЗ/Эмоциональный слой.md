# Эмоциональный слой

Единый сервис, который отслеживает входящие реплики + внутренние события и поддерживает текущее эмоциональное состояние (state + intensity). Экспортирует компактный snapshot другим модулям (LLM промпт, UI, Reflection).

## Цели
1 факт → 1 источник: все правила эмоций только здесь.
Снижение фликера: плавные переходы, гистерезис, минимум «дёрганий» тона.
Минимум вычислений: одна агрегация на сообщение.

## Состояние (state model)
| Атрибут | Тип | Диапазон | Описание |
|---------|-----|----------|----------|
| primary | enum | neutral, curious, caring, playful, intimate | Доминирующий эмоциональный режим |
| valence | float | -1..1 | Общая положительность |
| arousal | float | 0..1 | Уровень активации |
| confidence | float | 0..1 | Насколько модель уверена в интерпретации |
| stability_timer | int (s) | ≥0 | Сколько секунд осталось до разрешения перехода вниз |

Примеры маппинга (не дублировать в коде – таблица генерируется из YAML transitions):
| primary | Тон ответа кратко |
|---------|------------------|
| neutral | Спокойно, информативно |
| curious | Уточняющие вопросы |
| caring | Поддержка, эмпатия |
| playful | Лёгкая игривость |
| intimate | Тёплая близость, мягкие формулировки |

## Входные сигналы
| Источник | Сигнал | Пример |
|----------|--------|--------|
| NLP | sentiment (-1..1) | 0.7 |
| NLP | emotion_tags[] | ["sad"] |
| User | explicit_feedback | /mood reset |
| System | time_of_day | 23:10 (ночь → более мягко) |
| Memory | recent_context | Последние 3 сообщения пользователя |

## Алгоритм обновления
1. Собрать сигналы → нормализовать.
2. Обновить скалярные (valence, arousal) экспоненциальным сглаживанием.
3. Рассчитать candidate primary (правила + пороги).
4. Проверить гистерезис: если переход «вверх» – применить сразу, «вниз» – только когда stability_timer == 0.
5. Эмитировать событие EmotionShifted если primary изменился или delta(valence|arousal) > threshold.

## Гистерезис (параметры)
| Переход | up_threshold | down_threshold | min_hold_s |
|---------|--------------|----------------|------------|
| neutral→curious | valence>0 & arousal>0.25 | — | 20 |
| curious→caring | sentiment_avg< -0.2 | sentiment_avg>0 | 30 |
| caring→playful | arousal>0.55 | arousal<0.35 | 45 |
| playful→intimate | trust_score>0.6 & time>21:00 | trust_score<0.4 | 120 |

Все реальные значения → config: emotion/transitions.yaml

## События
| Event | Payload | Причина |
|-------|---------|---------|
| EmotionShifted | {from, to, valence, arousal, at} | Primary сменился |
| EmotionUpdated | {valence, arousal, at} | Скалярные изменились без смены primary |
| EmotionFeedbackReceived | {type, delta} | Пользователь скорректировал |

## Метрики
| Metric | Тип | Комментарий |
|--------|-----|-------------|
| emotion_primary_changes_total | counter | Частота переключений |
| emotion_primary_hold_seconds | histogram | Распределение удержания |
| emotion_valence | gauge | Текущая валентность |
| emotion_arousal | gauge | Текущая активация |
| emotion_confidence | gauge | Доверие к классификации |

## Конфигурация
emotion/config.yaml:
```yaml
smooth:
	alpha_valence: 0.2
	alpha_arousal: 0.25
thresholds:
	shift_valence_delta: 0.15
	shift_arousal_delta: 0.2
stability:
	default_hold_s: 20
```

transitions.yaml – таблица состояний (source, target, guard_expr, min_hold_s)

## Интерфейс модуля
EmotionService.get_snapshot() → Pydantic объект:
```json
{ "primary": "caring", "valence": 0.42, "arousal": 0.31 }
```
Используют: PromptBuilder, UI WebSocket streamer, Reflection.

## Ограничения / Не цели
Не храним длинную «историю эмоций» в памяти модуля → агрегация в Diary (events).
Не реализуем сложную модель психологии – только управляемые режимы тона.

## Будущее
Adaptive persona blending (weights per axis). 
User-tuned style constraints (opt-in).

## FSM (skeleton)

| from | to | guard_expr | min_hold_s | notes |
|------|----|-----------|-----------|-------|

TODO: define guards & dwell times.
