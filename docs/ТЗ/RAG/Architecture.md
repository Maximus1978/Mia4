# Архитектура RAG

Назначение: описать границы системы, компоненты и потоки данных/управления для Retrieval‑Augmented Generation в MIA4.

## Цели

- Модульный извлекатель, не завязанный на конкретный бэкенд (гибрид: sparse + dense; опциональные expansion и rerank)
- Управление через конфиг, без хардкода порогов (веса, top_k, нормализация)
- Наблюдаемость в первую очередь (события, метрики, логи)
- Воспроизводимость и тестируемость (unit + contract + integration + perf smoke)

## Компоненты

- QueryNormalizer: очистка и канонизация запроса; опциональные языковые подсказки
- QueryExpander (опционально): переписывает запрос в варианты; использует лёгкую LLM
- LexicalIndex: поиск BM25 по токенизированному тексту
- VectorIndex: поиск по плотным эмбеддингам (по умолчанию bge-m3; заменяемый)
- FusionEngine: нормализация скорингов + слияние (взвешенная сумма или RRF)
- ContextBuilder: дедупликация, бюджет по токенам, сборка сниппетов с цитатами
- RAGService: оркестрация пайплайна; эмитит события RAG.*
- MemoryQuery: внешний провайдер по `docs/ТЗ/Memory.md` для дневника/инсайтов

## Поток данных

1) Вход: RetrievalRequest(query_text, top_k, filters, strategies)
2) Нормализация: удаление шума, унификация регистра, детект языка
3) Expansion (опц.): QueryExpander возвращает N переписанных запросов; объединяются для retrieve
4) Лексический retrieve: BM25 возвращает (id, score_bm25)
5) Семантический retrieve: VectorIndex возвращает (id, score_sem)
6) Fusion: нормализация скорингов → комбинирование по весам (конфиг) → переранжирование
7) Сбор контекста: дедупликация по источнику, соблюдение бюджетов, добавление мета
8) Эмит RAG.ResultsReady и возврат RetrievalBundle

## Границы

- Индексации здесь нет; провайдеры ingest наполняют индексы
- Эмоции — только метаданные; на ранжирование не влияют
- Мультимодальность заложена полями modality, но пока не реализована

## Отказоустойчивость

- Пустой запрос → эмит QueryRequested + короткий путь с пустым результатом
- Индекс недоступен → фолбэк на доступную стратегию; метрика деградации
- Таймаут expansion LLM → продолжаем с базовым запросом; фиксируем метрику

## Наблюдаемость

- События: RAG.QueryRequested, RAG.ResultsReady, RAG.IndexRebuilt
- Метрики: retrieval_latency_ms, hit@k (eval), mrr (eval), context_tokens, expansion_rate, expansion_latency_ms

Подробности контрактов см. Interfaces.md, форматы событий — Events-and-Metrics.md.

