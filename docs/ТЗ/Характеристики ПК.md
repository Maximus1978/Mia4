# Environment Baseline

Аппаратная конфигурация (для интерпретации perf отчётов). Изменения фиксируются через changelog.

| Категория | Значение |
|-----------|----------|
| OS | Windows 11 |
| CPU | Intel Core i5-11600K @ 3.90GHz |
| RAM | 32 GB |
| GPU | NVIDIA GeForce RTX 4070 12GB |
| Python | 3.10 (venv) |

Дополнительно: версии ключевых библиотек зафиксированы в `requirements.lock`.

## Количество слоёв (`n_gpu_layers`) 
- в llama.cpp определяет, сколько слоёв нейросети будут вычисляться на GPU, а остальные — на CPU. Чем больше слоёв на GPU, тем выше скорость генерации и ниже задержка первого токена, особенно для больших моделей.

**Влияние параметра:**
- **Меньше слоёв на GPU** — больше вычислений на CPU, медленнее генерация, выше first_token_latency.
- **Больше слоёв на GPU** — быстрее генерация, ниже latency, но выше потребление видеопамяти (VRAM).

**Максимум для вашей видеокарты (RTX 4070, без OEM):**
- В среднем RTX 4070 (12 GB VRAM) может держать:
  - Для gpt-oss-20b-mxfp4 (20B, Q4_K_M): **до ~40–48 слоёв** на GPU без переполнения VRAM.
  - Для Q5/Q6 моделей — меньше слоёв (из-за большего размера слоя).
- Если указать слишком большое значение, llama.cpp выдаст ошибку или автоматически уменьшит число слоёв до максимально возможного.

**Практический совет:**
- Для стабильной работы и ускорения используйте `n_gpu_layers=40` для 20B Q4_K_M на RTX 4070.
- Если получите ошибку out of memory — уменьшите значение (например, до 32).
- Для меньших моделей (7B, 13B) можно ставить больше слоёв (до 60–80).

**Как узнать максимум:**
- Запустите с заведомо большим значением, например `n_gpu_layers=80` — llama.cpp в логе напишет, сколько реально удалось загрузить.
- В логах ищите строку вида:  
  `llama.cpp: offloading 40 layers to GPU, 0 layers to CPU`

**Резюме:**
- Чем больше слоёв на GPU — тем быстрее работает модель.
- Для RTX 4070 без OEM оптимально: **40–48 слоёв** для 20B Q4_K_M.
- Проверяйте логи, чтобы подобрать максимум без ошибок.

Если хотите автоматизировать подбор — можно добавить скрипт, который сам определяет максимум по VRAM и типу модели.
