# Слой роста (Reflection / Growth Layer)

Назначение: периодически (и частично он‑лайн) превращать сырые события (сообщения, эмоции) в компактные артефакты памяти: diary entries, themes, insights.

## Артефакты
| Тип | Таблица / Хранилище | Поля (ключевые) | TTL / Ротация |
|-----|---------------------|-----------------|---------------|
| diary_entry | sqlite: diary | id, ts, role, text, emotion_snapshot | сохраняем все |
| theme_window | sqlite: themes | id, period_start, period_end, top_terms[], sentiment_avg | 30 дней |
| insight | sqlite: insights | id, created_at, kind, text, confidence, novelty_score | ревью / удаление вручную |
| memory_vector | qdrant | id, embedding, payload(ref=diary_entry) | оптимизация через compaction |

## Потоки (pipelines)
1. OnMessage (реaltime): сохраняет diary_entry → эмитит MemoryAppended.
2. Nightly (scheduler):
	 - Load last 24h entries
	 - Extract candidate facts (LLM) + topics (tf-idf / embeddings clustering)
	 - Compute sentiments & emotion aggregates
	 - Generate insights (rules + LLM summarizer)
	 - Persist themes + insights
3. Weekly: сжатие (merge похожих insights, архив устаревших тем).

## Insight генерация
Правило → LLM дооформление:
1. Rule filter (min repetitions ≥2, novelty_score>0.3)
2. Compose prompt (context facts + recent emotions)
3. Validate length & no PII leakage
4. Write insight + emit InsightCreated

## Новизна (novelty_score)
cosine(candidate_embedding, existing_insights_mean) → score = 1 - cosine.
Порог novelty_min=0.25 (config: reflection.yaml)

## События
| Event | Payload | Используют |
|-------|---------|------------|
| MemoryAppended | {entry_id} | RAG indexer, Emotion (агрегации) |
| ReflectionStarted | {window} | Logs/metrics |
| ReflectionCompleted | {window, insights} | UI notifier |
| InsightCreated | {id, kind, text} | UI, Evaluator |
| InsightRejected | {reason} | Logs |

## Метрики
| Metric | Тип | Комментарий |
|--------|-----|-------------|
| reflection_duration_seconds | histogram | Время ночного цикла |
| insights_generated_total | counter | Сырые инсайты до фильтра |
| insights_accepted_total | counter | После фильтра |
| insight_novelty_score | histogram | Распределение новизны |
| diary_entries_24h | gauge | Количество свежих сообщений |

## Конфигурация (reflection.yaml)
```yaml
nightly:
	hour: 02
	max_context_messages: 500
novelty:
	min_score: 0.25
insight:
	max_len: 260
	max_per_night: 6
```

## Интерфейсы
ReflectionService.run_nightly(window) – запускает полный цикл.
ReflectionService.generate_on_demand(last_n=50) – пользовательский запрос.
InsightRepository.review(id, action) – пометка/удаление.

## Ограничения
Не проводим дообучение LLM локально (дорого) – работаем на уровне извлечения и сжатия.
Не храним сырые аудиозаписи → только транскрипт.

## Будущее
Temporal reasoning (timeline merges).
User feedback loop (оценка инсайта → улучшение правил).