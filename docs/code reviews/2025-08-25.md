# Код-ревью после рефактора [[docs/changelog/2025-08-25|2025-08-25]]

Ниже обзор (фокус: архитектура, риски, точки роста). Старался быть ёмким.

## Архитектура (сильные стороны)
- Модульная конфигурация + миграция legacy: удачно отделено, кэширование через lru_cache упрощает доступ.
- ModuleManager + LLMModule: lazy init, capability routing, единый GenerationResult — хорошая база для дальнейших модулей.
- Импорт‑гард (import_graph) + тест: ранняя защита слоёв.
- Документация синхронизирована (автоген config схем + ручной реестр).

## Критические / High (стоит запланировать)
1. Конфиг ENV парсинг: сейчас bool только true/false; '1', '0', 'TRUE', пустая строка → неожиданные строки. Нужно унифицировать (map {“1”,”true”,”yes”} → True).
2. Отсутствует централизованный EventBus (emit просто вызывает обработчики?) — нет явной подписки / очереди / версионирования payload (упомянуто, но не реализовано).
3. Потенциальная гонка при многопоточном доступе к LLMModule._providers (нет lock) — если вызовы параллельны: двойная загрузка или состояние partially initialized.
4. Отсутствует политика освобождения ресурсов (unload) кроме idle sweep — нет верхнего лимита загруженных моделей / LRU.
5. Нет валидации capabilities (пустой список → fallback silently; стоит логировать «no exact match, fallback primary» с уровнем debug/info).

## Medium
1. GenerationResult не описывает ошибочные завершения (нет status/error_code) — perf/observability потом придется расширять, лучше добавить теперь.
2. import_graph парсит строки (регекс) — не ловит динамические/многострочные импорты; можно заменить на ast.walk для надёжности.
3. test_generated_config_docs: сравнивает snapshot только по байтам — не ловит случайный пропуск блока (ок, но можно доп. проверку упорядоченности / отсутствия пустых таблиц).
4. В README нет секции про ограничения (stream поддержка, отсутствие RAG). Короткая «Current Limitations» повысит прозрачность.
5. ENV override не логируется — трудно понять почему значение «не такое». Нужен debug журнал применённых переменных (mask sensitive позже).
6. clear_config_cache не сбрасывает side-car (e.g. module_manager) — тесты могут держать устаревшие ссылки.

## Low
1. OptionalMoEConfig.id: default None, но enabled=False — если включить забыв id → ошибка позже (лучше валидация: if enabled and not id → ValueError).
2. n_gpu_layers тип str | int: если пользователь поставит ‘AUTO’ в верхнем регистре — не приведётся. Можно привести lower().
3. import_graph исключения (factory → module_manager) — стоит TODO с датой снятия.
4. metrics.py (заготовка) — лучше явно пометить deprecated или planned, чтобы не путало читателя.
5. scripts/generate_config_docs: простая фильтрация классов — при добавлении служебных моделей (internal BaseModel) их тоже возьмёт (можно маркер skip).

## Незаполненные пробелы / будущие интеграции
- EventBus: нужна подписка, очередь, версия payload, возможно sync + async обработка.
- Observability: structured logging + trace id (propagate через GenerationResult / события).
- PerfCollector: событийному слою нужны агрегаты p50/p95; пока закладка есть (GenerationResult.timings).
- RAG/Memory интерфейсы: подготовить минимальные Protocol/ABC (Retriever, VectorStore) — облегчает интеграцию без реализации.
- Health endpoint / health snapshot (модули enabled/loaded, версии, checksum ok).
- Validation тест для defaults (Config-Registry ↔ Generated-Config.md: ensure every documented key exists в runtime dict).
- Security: нет sandbox для путей (model path в манифесте может указывать вне models/). Добавить проверку prefix containment.

## Тестовое покрытие — предложения
- Конкурентные обращения к get_provider (ThreadPool) → один экземпляр.
- ENV override precedence тест (base + overrides + ENV).
- Ошибка checksum (skip_checksum=False) — корректная реакция.
- Fallback capability (отсутствует требуемая) — лог + возврат primary.
- Sweep idle edge: модель без last_used не должна выгружаться.
- Negative: invalid reasoning mode → возвращаются исходные параметры (assert идентичность dict).
- Snapshot Generated-Config содержит все namespaces из SUB_SCHEMA_CLASSES (би-дирекционное соответствие).

## Документация — улучшить
- Отметить переходный слой factory (target removal).
- Добавить перечень архитектурных инвариантов (таблица) в отдельный `ARCHITECTURE_GUARDS.md` (import rules, single orchestrator, no module→module_manager).
- Perf.md: указать текущий статус (collector pending) и link на GenerationResult структуру.

## Риски эволюции
- Расширение GenerationResult может сломать perf скрипты (зафиксировать version field заранее).
- При добавлении perf модуля возможны циклы через metrics/events — удерживать perf в отдельном пакете без импорта core.llm.
- Возможный рост времени загрузки при множестве моделей — нужен lazy manifest indexing (уже есть) + deferred checksum.

## Быстрые «low-risk» улучшения (можно планово)
1. Добавить threading.Lock в LLMModule вокруг _load_provider.
2. Добавить error/status в GenerationResult (e.g. success: bool, error: str|None).
3. AST парсер для import_graph (10–15 строк).
4. Лог ENV overrides (debug).
5. Валидация OptionalMoEConfig (enabled implies id).
6. TODO маркеры со ссылкой на issue/номер sprint.

## Итог
Архитектурный фундамент здоровый: модульная конфигурация, маршрутизация, контракт результата и защитные тесты уже заложены. Основные следующие инвестиции: формализация EventBus, потокобезопасность LLMModule, расширение GenerationResult и наблюдаемость. Всё остальное — эволюционные улучшения.

Если нужен приоритизированный план фиксов — скажи, составлю последовательность.