# ADR-0023: Harmony Unexpected Channel / Final Order Handling

Status: Draft
Date: 2025-09-03

## Контекст

Harmony поток предполагает упорядоченность каналов (analysis → commentary → final) и единственность финального завершения.
Реальные модели (особенно локальные / частично дообученные) могут:

- Эмитить несколько `final` сегментов.
- Смешивать `analysis` и `final` (перемежение после первого final).
- Отдавать commentary после final.
- Дублировать закрывающие маркеры (например повтор `<|return|>` эквивалентов) или частично обрезанные секвенции.

Нужно определить стратегию: жёстко прерывать (ошибка) или мягко деградировать с телеметрией.
Прямой abort ухудшит UX (частичная полезная выдача теряется). Отсутствие учёта — теряем сигнал качества модели / настройков.

## Цель

1. Сохранить максимально полезный final пользователю.
2. Измерять частоту аномалий для последующего тюнинга адаптера / промпта.
3. Не допустить "тихой" потери метрик (каждое отклонение регистрируется).

## Скоуп (MVP)

Отслеживаем четыре класса отклонений:

1. `extra_final` — больше одного завершения final.
2. `analysis_after_final` — токены analysis после первого final.
3. `commentary_after_final` — commentary после final.
4. `interleaved_final` — final затем возврат к другим каналам (микс).

## Решение

В адаптере после фиксации первого final:

- Допускаем поступление остальных токенов, но:
  - Игнорируем их для накопления финального текста (final остаётся по первому завершению или выбираемый вариант — см. параметр ниже).
  - Регистрируем тип аномалии в счётчике.

Добавляем метрику:

- `harmony_unexpected_order_total{type}` — инкремент на каждый зафиксированный случай (type ∈ {extra_final, analysis_after_final, commentary_after_final, interleaved_final}).

Конфигурация (`configs/base.yaml`):

```yaml
harmony:
  unexpected_order:
    strategy: first_final   # first_final | last_final | concat (будущее)
    enabled: true
```

Интерпретация `strategy`:

- `first_final` (MVP): первый final фиксируется как пользовательский вывод; последующие игнорируются.
- (Зарезервировано) `last_final`: перезаписывать финал каждый раз (риск нестабильности вывода).
- (Зарезервировано) `concat`: конкатенировать (риск дублирования / мусора).

Fallback поведение при disabled / отсутсвии секции: ведём себя как `first_final` но не считаем метрики (для отладки / экспериментов).

## Альтернативы

1. Жёсткий abort на первом нарушении — теряем полезный контент.
2. Silent ignore без метрики — отсутствует обратная связь.
3. Немедленная попытка пере-генерации — удорожает запрос, сложная семантика.

## Обоснование

MVP минимально инвазивен и даёт измеримость:

- Простая реализация (флаг seen_final + свитч стратегии).
- Метрика позволяет строить долю аномалий по модели / версии промпта.
- Расширяемый enum типов нарушений.

## Последствия

### Положительные

- Сохраняем пользовательский финал (не ломаем UX).
- Видим точное распределение типов нарушений.
- Подготовка к будущему auto-tuning промпта.

### Отрицательные

- Небольшой оверхед счётчика и условных веток.
- Возможен шум от редких ложных срабатываний (регекс / токенизация). Требуются тесты.

## Наблюдаемость

Метрика: `harmony_unexpected_order_total{type}`.
Дополнительно логируем debug-запись с первым 120 символов отклоняющегося сегмента (sanitize). Повторяющиеся типы в рамках одного запроса могут быть агрегированы (инкремент >1) — допускается.

## Тестирование

Unit:

- Генерация с двумя final → type=extra_final.
- Final затем commentary → commentary_after_final.
- Final затем analysis → analysis_after_final.
- Final → commentary → analysis → interleaved_final (фиксируется interleaved как более общий?)

Правило при множественных: регистрируем каждый конкретный тип (инкременты по каждому событию), `interleaved_final` фиксируется при смене канала после final вне зависимости от конкретного канала.

Integration:

- Поток с нарушениями возвращает первый final в API и инкрементирует соответствующие метрики.
- Отключение (`enabled=false`) → метрика не растёт.

Contract:

- Отсутствие новых полей в ответе API (изменения прозрачны для клиента).

## Миграция

1. Добавить секцию конфигурации.
2. Расширить адаптер логикой фиксации seen_final и подсчёта нарушений.
3. Зарегистрировать метрику.
4. Добавить unit + integration тесты.
5. Обновить `API.md` (краткая заметка: final стабилизирован по стратегии). Добавить changelog запись.

## Связанные документы

- Execution Plan Step 10 (Unexpected Order Handling)
- Harmony Streaming Migration (ADR-0020)

## Открытые вопросы

- Нужна ли деградация до concat для некоторых моделей? (отложено)
- Стоит ли эмитить событие `HarmonyUnexpectedOrder` с деталями? (можно добавить позднее при необходимости).

## Примечания

Расширение в будущем: partial recovery / re-ask для крытических нарушений.
