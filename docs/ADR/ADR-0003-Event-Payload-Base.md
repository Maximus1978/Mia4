# ADR-0003: Event Payload Base & Correlation

Status: Accepted (2025-08-25)

## Контекст

Нужна единая основа для всех payload событий (EventBus v1) чтобы обеспечить трассировку, согласованность идентификаторов и возможность эволюции без ломки потребителей. Принято решение использовать `uuid v7` и ввести `workspace_id` уровень.

## Решение

Базовые обязательные поля каждого payload (минимум):

```json
{
  "event": "Message.Appended",
  "ts": 1732551112.123,          // float epoch seconds
  "id": "018fa9c8-...",         // uuid v7 уникальный id события
  "correlation_id": "018fa9c8-...", // для связывания цепочек (generation → speech)
  "workspace_id": "018fa9b0-...",
  "session_id": "018fa9b1-..."   // может быть null для глобальных
}
```

Правила:
1. `id` всегда uuid v7; `correlation_id` копируется из инициирующего события или = id если корневое.
2. `workspace_id` обязателен если присутствует `session_id`.
3. Версионирование структуры определённого события через добавление поля `v` (int) либо смену имени (Message.Appended.v2) — предпочтителен `v`.
4. Дополнительные поля события НЕ пересекаются с базовыми (зарезервированы: id, event, ts, correlation_id, workspace_id, session_id, v).
5. Meta-расширения помещаются в под-объект `meta`.

## Варианты
1. Не вводить correlation_id (дешевле) — усложнит трассировку цепочек.
2. Использовать ULID — нет встроенной поддержки в стандартной библиотеке.

## Обоснование
uuid v7: монотонность (упорядочиваемость по времени) + широкая поддержка сторонних библиотек. Базовое подмножество полей облегчает фильтрацию потоков логов.

## Последствия
Потребители упрощённо валидируют наличие базовых полей. Появляется единый коридор эволюции.

## Положительные
- Унификация трассировки.
- Возможность агрегации метрик по correlation_id.

## Отрицательные
- Слабая схема (dict) до введения строгих моделей.

## Безопасность / Наблюдаемость
Correlation_id позволяет связывать доступ к ресурсам и генерацию; возможно внедрение rate limiting по цепочке.

## Связанные документы
- ADR-0002 EventBus Design
- Events.md (расширено, включает новые события Session.*, Attachment.*, Speech.*, Media.*)

## Примечания
Переход на pydantic слой (typed events) планируется в v2 EventBus.
