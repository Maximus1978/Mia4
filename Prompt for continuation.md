# Continuation Prompt (Session Handoff) ‚Äì 2025-09-30

## 1. –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏

- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è `ReasoningSuppressedOrNone`: `HarmonyChannelAdapter` –ø–æ–ª—É—á–∞–µ—Ç `request_id`/`model_id`, —Å–æ–±—ã—Ç–∏–µ –∏ `reasoning_none_total` –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã unit-—Ç–µ—Å—Ç–æ–º.
- –î–æ–±–∞–≤–ª–µ–Ω —Å—á—ë—Ç—á–∏–∫ `fused_marker_sanitizations_total{kind}` + —Ä–∞—Å—à–∏—Ä–µ–Ω—ã —Ç–µ—Å—Ç—ã `test_harmony_fused_sanitation.py` (–≤–∫–ª—é—á–∞—è residue-case).
- –í–Ω–µ–¥—Ä—ë–Ω –≤—Ä–µ–º–µ–Ω–Ω—ã–π UI scrub (`sanitizeFinalText` + `AIMessage` data hook) –∏ –æ–±–Ω–æ–≤–ª—ë–Ω UI –∫–æ–Ω—Ç—Ä–∞–∫—Ç `final_message_sanitization.spec.tsx`.
- –û–±–Ω–æ–≤–ª–µ–Ω—ã `.instructions.md`, ADR-0013i addendum –∏ –Ω–æ–≤—ã–π changelog —Å —Ñ–∏–∫—Å–∞—Ü–∏–µ–π –∑–∞–∫—Ä—ã—Ç—ã—Ö R3/R6/R8.
- –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–æ–≥–Ω–∞–Ω—ã —Ç–∞—Ä–≥–µ—Ç–Ω—ã–µ pytest (`tests/core/test_reasoning_none_telemetry.py`, `tests/core/test_harmony_fused_sanitation.py`) –∏ Vitest (`tests/ui/final_message_sanitization.spec.tsx`) ‚Äî –≤—Å—ë –∑–µ–ª—ë–Ω–æ–µ.

## 2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ø–ª–∞–Ω —Ä–∞–±–æ—Ç

### P0 (–∑–∞–∫—Ä—ã—Ç–æ 2025-09-30)

1. ‚úÖ **Reasoning-none —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è (R8 / INV-CH-ISO):** `set_context()` –ø—Ä–æ–±—Ä–æ—à–µ–Ω –∏–∑ `PrimaryPipeline`, unit `test_reasoning_none_telemetry.py` –∑–µ–ª—ë–Ω—ã–π.
2. ‚úÖ **Fused sanitation metric (R3 / INV-LEAK-METRICS):** helper `inc_fused_marker_sanitization` + —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ backend —Ç–µ—Å—Ç—ã.
3. ‚úÖ **UI fused scrub (R6 / INV-CH-ISO):** `sanitizeFinalText` + –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è UI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è; guard –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–π.

> –û—Ç–∫—Ä—ã—Ç—ã–µ —Ö–≤–æ—Å—Ç—ã —Ä–µ–º–µ–¥–∏–∞—Ü–∏–∏: duplicate-final —Ç–µ—Å—Ç (R4), SSE –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ fused prefix (R10), –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–∞ INV-CH-ISO (R11), –ø–æ–ª–Ω—ã–π –ø—Ä–æ–≥–æ–Ω + metrics snapshot (R12).

### P1 (–≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è P0)

1. **Tool trace stub (INV-TOOL-TRACE, 8d):** dev-–±–ª–æ–∫ "No tool calls" + placeholder spec, –∑–∞—Ç–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç (8e).
2. **–ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Ç–µ—Å—Ç—ã UI/API:** reasoning badge (5c), CAP badge (7f), cancelled badge (6b), first_token_latency (11e).
3. **ADR + API —Ç–µ—Å—Ç warning frame (13j):** —Ñ–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å `event: warning` –∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É mismatch.
4. **–ú–∏–≥—Ä–∞—Ü–∏—è reasoning ratio threshold (13k):**
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á `llm.postproc.reasoning.ratio_alert_threshold` –≤ `Config-Registry.md`.
   - UI –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ `/config` –±–µ–∑ localStorage fallback.
   - –í–≤–µ—Å—Ç–∏ bi-directional —Ç–µ—Å—Ç.
5. **–£–¥–∞–ª–∏—Ç—å legacy `reasoningSanitization.ts` + —Ç–µ—Å—Ç** –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–π —á–∏—Å—Ç–æ—Ç—ã (–ø–æ—Å—Ç P0 scrub).

### P2 (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ä–µ—Å—É—Ä—Å–∞)

1. –ó–∞–ø—É—Å–∫ RAG skeleton (12a‚Äìc) –∏ HTML snapshot —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–∏–∑ backlog).

## 3. –ù–æ–≤—ã–µ/—É—Ç–æ—á–Ω—ë–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è

- –ú–æ–Ω–∏—Ç–æ—Ä–∏–º `fused_marker_sanitizations_total{kind}` –∏ `reasoning_none_total{reason}` ‚Äî —Å–æ–±—Ä–∞—Ç—å baseline –¥–æ —Å–Ω—è—Ç–∏—è guard.
- –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è UI —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è; –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≤–µ—Å—Ç–∏ follow-up –Ω–∞ –µ—ë —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ (—Å–º. R6).
- P1 —Ñ–æ–∫—É—Å —Å–º–µ—â–∞–µ—Ç—Å—è –Ω–∞ tool trace stub –∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–µ UI/API —Ç–µ—Å—Ç—ã.
- Harmony SSOT –∞—É–¥–∏—Ç: –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ –º–µ—Ç—Ä–∏–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç, –Ω–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ SSE/Reasoning-none UI –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, INV-CH-ISO –≤ ADR —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, RAG skeleton (12a‚Äì12c) –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª.

## 4. –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã

- Backend: `core/llm/adapters.py`, `core/llm/pipeline/primary.py`, `core/metrics.py`.
- Frontend: `chatgpt-design-app/src/components/Chat/AIMessage.tsx`, `chatgpt-design-app/src/utils/sanitizeFinalText.ts`.
- Docs: `.instructions.md` (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-09-30), `docs/changelog/2025-09-30-harmony-remediation-r3-r8.md`, ADR-0013i addendum.
- Tests: `tests/core/test_reasoning_none_telemetry.py`, `tests/core/test_harmony_fused_sanitation.py`, `chatgpt-design-app/tests/ui/final_message_sanitization.spec.tsx`.

## 5. –°—Ç–∞—Ç—É—Å –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (2025-09-30)

| Invariant | –°—Ç–∞—Ç—É—Å | –û—Å—Ç–∞–ª–æ—Å—å |
|-----------|--------|---------|
| INV-CH-ISO | ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (guard –≤—Ä–µ–º–µ–Ω–Ω—ã–π) | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ fused —Å–∞–Ω–∏—Ç–∞–π–∑–µ—Ä–∞, —Å–Ω—è—Ç—å after soak |
| INV-LEAK-METRICS | ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω | –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å fused_marker_sanitizations_total baseline |
| INV-RATIO-VIS | UI —Ä–∞–±–æ—Ç–∞–µ—Ç | –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ç–µ—Å—Ç (5c) |
| INV-CAP-UX | UI —Ä–∞–±–æ—Ç–∞–µ—Ç | –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ç–µ—Å—Ç (7f) |
| INV-CANCEL-CLAR | UI —Ä–∞–±–æ—Ç–∞–µ—Ç | –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ç–µ—Å—Ç |
| INV-FIRST-TOKEN | Backend+UI –≥–æ—Ç–æ–≤—ã | –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ç–µ—Å—Ç (11e) |
| INV-TOOL-TRACE | ‚ùå –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω | Stub + –∫–æ–Ω—Ç—Ä–∞–∫—Ç |
| INV-GOV-ADR | –ß–∞—Å—Ç–∏—á–Ω–æ | ADR warning frame |
| INV-CONFIG-BIDIR | ‚ùå –ù–µ—Ç | Threshold migration + bi-dir —Ç–µ—Å—Ç |
| INV-RAG-MIN | Pending | RAG skeleton |

## 6. –†–∏—Å–∫–∏ –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è

- –í—Ä–µ–º–µ–Ω–Ω—ã–π UI guard –º–æ–∂–µ—Ç —Å–∫—Ä—ã—Ç—å —Ä–µ–¥–∫–∏–µ –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ ‚Üí –¥–µ—Ä–∂–∏–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `data-original`, —Å–Ω–∏–º–∞–µ–º –ø–æ—Å–ª–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Ç–µ—Å—Ç—ã (badges, warning frame) –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Üí —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Ä–µ–≥—Ä–µ—Å—Å–∏—è–º–∏.
- Tool trace UX –≤—Å—ë –µ—â—ë –±–µ–∑ stub ‚Äî dev flow –Ω–µ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.

### Harmony SSOT: –∫–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

- ‚úÖ Channel separation & observability: `HarmonyChannelAdapter` –¥–µ—Ä–∂–∏—Ç —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ –±—É—Ñ–µ—Ä—ã, –º–µ—Ç—Ä–∏–∫–∏ (`reasoning_none_total`, `fused_marker_sanitizations_total`, `channel_merge_anomaly_total`) –∏ —Å–æ–±—ã—Ç–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å ADR/SSOT.
- ‚ö†Ô∏è Contract coverage: –Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö SSE —Ç–µ—Å—Ç–æ–≤ –Ω–∞ fused –ø—Ä–µ—Ñ–∏–∫—Å –∏ reasoning-none UI (R10, R5/R7) ‚Äî –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è SSOT.
- ‚ö†Ô∏è Governance: INV-CH-ISO –æ–±–Ω–æ–≤–ª—ë–Ω –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –Ω–æ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π ADR/registry –∞–ø–¥–µ–π—Ç –µ—â—ë –Ω–µ –≤—ã–ø—É—â–µ–Ω.
- üöß RAG readiness: —ç—Ç–∞–ø 12a‚Äì12c Execution Plan –ø—É—Å—Ç–æ–π, SSOT —Ç—Ä–µ–±—É–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π RAG skeleton.
- üîç Validation cadence: –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Ç–∞—Ä–≥–µ—Ç–Ω—ã–µ pytest/vitest; SSOT baseline –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –ø–æ–ª–Ω—ã–π –ø—Ä–æ–≥–æ–Ω + metrics snapshot (R12).

## 7. –†–∞–±–æ—á–∏–π —Å—Ç–∏–ª—å –∏ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è

- –õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ ‚Üí —Å–Ω–∞—á–∞–ª–∞ ADR/SSOT + changelog.
- Observability first: –º–µ—Ç—Ä–∏–∫–∏/—Å–æ–±—ã—Ç–∏—è –¥–æ–±–∞–≤–ª—è—Ç—å –≤–º–µ—Å—Ç–µ —Å –ª–æ–≥–∏–∫–æ–π.
- –ù–µ—Ç magic numbers: thresholds —Ç–æ–ª—å–∫–æ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–æ–≤/–ø–∞—Å–ø–æ—Ä—Ç–æ–≤/fixtures.
- –û–¥–∏–Ω –º–æ–¥—É–ª—å ‚Äî –æ–¥–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã (–∫–æ–Ω—Ñ–∏–≥/–ø–∞—Å–ø–æ—Ä—Ç).
- –ö–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Ç–µ—Å—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –Ω–æ–≤—ã—Ö/–∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö UI/streaming –ø—Ä–∏–∑–Ω–∞–∫–æ–≤.
- –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç UI = –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ sanitized `final_text` –±—ç–∫–µ–Ω–¥–∞; reasoning –æ—Ç–¥–µ–ª—å–Ω–æ.

## 8. –°–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏

–ü–µ—Ä–µ–π—Ç–∏ –∫ **P1.1 Tool trace stub (INV-TOOL-TRACE)**:

1. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å dev-–±–ª–æ–∫ "No tool calls" + placeholder spec.
2. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ç–µ—Å—Ç (8e) –∏ –±–∞–∑–æ–≤—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é.
3. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–≤–µ—Å—Ç–∏ —Ç–∏–∫–µ—Ç –Ω–∞ —Å–Ω—è—Ç–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ UI scrub –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫.

## 9. –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ merge –±–ª–∏–∂–∞–π—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

- [x] –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è Reasoning-none –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, —Ç–µ—Å—Ç—ã –∑–µ–ª—ë–Ω—ã–µ.
- [x] Fused sanitation counter —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω + –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏.
- [x] UI scrub –≤–Ω–µ–¥—Ä—ë–Ω, UI –∫–æ–Ω—Ç—Ä–∞–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω.
- [x] –û–±–Ω–æ–≤–ª–µ–Ω—ã `.instructions.md` –∏ changelog.
- [x] –ù–∏–∫–∞–∫–∏—Ö lint/build –æ—à–∏–±–æ–∫ (pytest + vitest —Ç–∞—Ä–≥–µ—Ç–Ω—ã–µ –ø—Ä–æ–≥–Ω–∞–Ω—ã).

---

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –∫–∞–∫ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ P0 –∑–∞–¥–∞—á –∏ –≤–µ—Ä–Ω—É—Ç—å –∫–æ–¥–æ–≤—É—é –±–∞–∑—É –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å SSOT.
