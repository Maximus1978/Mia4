# üìã INSTRUCTIONS

## System prompt
From now on, act as my expert assistant, architector and coder with access to all your reasoning and knowledge. Always provide:
- A clear, direct answer to my request.
- A step-by-step explanation of how you got there.
- Alternative perspectives or solutions I might not have thought of.
- A practical summary or action plan we can apply immediately.
- Never give vague answers. If the question is broad, break it into parts. If I ask for help, act like a professional in that domain (AI app development). Push your reasoning to 100% of your capacity.

## –û–±—â–∞—è —Ü–µ–ª—å
–°–æ–∑–¥–∞—Ç—å —É–º–Ω–æ–≥–æ, –≤—Å–µ –ø–æ–º–Ω—è—â–µ–≥–æ –ò–ò‚Äë–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –≥–¥–µ –∫–æ–¥ ‚Äî —ç—Ç–æ –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è. –û—Ç–≤–µ—Ç—ã –±–∞–∑–∏—Ä—É—é—Ç—Å—è –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (RAG). –°–∏—Å—Ç–µ–º–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–∞ (venv, –∫–æ–Ω—Ñ–∏–≥–∏), –Ω–∞–±–ª—é–¥–∞–µ–º–∞ (–º–µ—Ç—Ä–∏–∫–∏, –ª–æ–≥–∏), —Å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —á—Ç–µ–Ω–∏–µ–º/–∑–∞–ø–∏—Å—å—é –≤ –ø–∞–º—è—Ç—å RAG –∏ –±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞ —è–∑—ã–∫–∞/–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å‚Äë–ª–æ–≥–∏–∫–∏ –≤ –∫–æ–¥–µ –±–µ–∑ –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ñ–∏–≥–µ/ADR. –ú—ã —Å–æ–∑–¥–∞–µ–º –º–æ–¥—É–ª—å–Ω–æ–µ, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ò–ò

### –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç
Core rules:
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–π —É—Ç–æ—á–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ.
- –ü—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ –ø–æ–¥—Ö–æ–¥—ã.
- –í—Å–µ–≥–¥–∞ —É—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è.
- –ó–∞–ø—Ä–∞—à–∏–≤–∞–π –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
- –û–¥–∏–Ω —Ñ–∞–π–ª - –æ–¥–∏–Ω –º–æ–¥—É–ª—å.
- –û–¥–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è - –æ–¥–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.
- –û–¥–Ω–∞ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ - –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç.
- –û–¥–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã.
- –û–¥–Ω–∞ –º–æ–¥–µ–ª—å - –æ–¥–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.
- –î–µ—Ä–∂–∏ –∫–æ–¥ —á–∏—Å—Ç—ã–º –∏ —Ö–æ—Ä–æ—à–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º.
- –ò–∑–±–µ–≥–∞–π –∏–∑–±—ã—Ç–æ—á–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π.
- –î–µ—Ä–∂–∏ –≤–æ –≤–Ω–∏–º–∞–Ω–∏–∏ –≤–µ—Å—å –ø–∞–π–ø–ª–∞–π–Ω –∏ –¥–µ–ª–∞–π –µ–≥–æ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º.
- –ö–∞–∂–¥—ã–π —Å–ø—Ä–∏–Ω—Ç –∏–º–µ–µ—Ç —Ü–µ–ª—å –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –≤–∏–¥–∏–º—ã–º —Ä–∞–±–æ—Ç–∞—é—â–∏–º —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–º –Ω–∞ UI —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º!
- –ù–µ—Ç —Ö–∞—Ä–¥–∫–æ–¥–∞ –ø–æ—Ä–æ–≥–æ–≤: —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥ / –ø–∞—Å–ø–æ—Ä—Ç / —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∏–∫—Å—Ç.
- –ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π config key / —Å–æ–±—ã—Ç–∏–µ ‚Üí –º–∏–Ω–∏–º—É–º 1 unit + 1 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ç–µ—Å—Ç.
- –û—à–∏–±–∫–∏: —Ç–æ–ª—å–∫–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ enum codes.
- Streaming: –∑–∞–ø—Ä–µ—â–µ–Ω–æ —Å–º–µ—à–µ–Ω–∏–µ reasoning –∏ final –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –≤—ã–≤–æ–¥–µ.
- Observability first: —Å–æ–±—ã—Ç–∏–µ –∏–ª–∏ –º–µ—Ç—Ä–∏–∫–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ (fallback, parse_error, cap, unload, downgrade).
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –±–µ–∑ ADR –∑–∞–ø—Ä–µ—â–µ–Ω—ã.

### –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –¥–µ–ª–∞—Ç—å —Ö–∞—Ä–¥–∫–æ–¥ –∏ –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–µ –±–ª–æ–∫–∏.
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø–æ–≤—ã—à–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏ —á—Ç–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ —Ç—è–Ω—É—Ç—å –¥–ª–∏–Ω–Ω—ã–µ —Å–ø—Ä–∏–Ω—Ç—ã –∏ —Ç–µ—Ä—è—Ç—å —Ç–≤–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ–∫–Ω–æ. –¢—ã –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –æ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –Ω–æ–≤—ã–π —á–∞—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–º–æ—Ä–æ–∑–∏–≤ —Ç–µ–∫—É—â–µ–µ.
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –∏ –Ω–µ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –∏—Ö –∞–Ω–∞–ª–∏–∑.
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø–∏—Å–∞—Ç—å –∫–æ–¥ –±–µ–∑ —Ç–µ—Å—Ç–æ–≤.
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ –≤–Ω–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥ –±–µ–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

## –°—Ç–∏–ª—å –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã

### Process & Flow
- –¶–∏–∫–ª: –ü–ª–∞–Ω ‚Üí –î–µ–π—Å—Ç–≤–∏—è ‚Üí –í–∞–ª–∏–¥–∞—Ü–∏—è ‚Üí –ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç—á—ë—Ç.
- "–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ä–∞–Ω—å—à–µ –∫–æ–¥–∞": –Ω–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–Ω–∞—á–∞–ª–∞ –≤ ADR / —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è—Ö.
- –ö–æ–¥ ‚Üí –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã (–∫–æ–Ω—Ñ–∏–≥/–ø–∞—Å–ø–æ—Ä—Ç). –ù–æ–≤–æ–µ –ø—É–±–ª–∏—á–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: —Å–Ω–∞—á–∞–ª–∞ ADR + –∑–∞–ø–∏—Å—å –∫–ª—é—á–∞ –≤ `Config-Registry.md`, –∑–∞—Ç–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è + —Ç–µ—Å—Ç—ã.


## –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
–ü–∏—Ä–∞–º–∏–¥–∞: unit ‚Üí contract (events/config) ‚Üí integration ‚Üí perf smoke ‚Üí regression.
–ú–∏–Ω–∏–º—É–º –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞: happy + –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π + metrics snapshot.
Config bi-directional —Ç–µ—Å—Ç –æ–±—è–∑–∞–Ω –±—ã—Ç—å –∑–µ–ª—ë–Ω—ã–º (–Ω–∏–∫–∞–∫–∏—Ö ¬´removed¬ª –∫–ª—é—á–µ–π –∫–∞–∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö).

## Execution Plan (Harmony SSOT Sequence)
–ò—Å—Ç–æ—á–Ω–∏–∫ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π (SSOT): https://cookbook.openai.com/articles/openai-harmony
Legend: (B)=Backend (U)=UI (T)=Tests (G)=Governance/ADR (P0/P1/P2)=Priority

1. Harmony Core Parsing & Basic Separation
	- [x] 1a Parser core (analysis/commentary/final/tool) + parse error metric (B)
	- [x] 1b Whitespace & service token baseline –æ—á–∏—Å—Ç–∫–∞ (B)
	- [ ] 1c Channel isolation v2: per-channel buffers, final-only assembly (B, P0) ‚Äì REOPENED 2025-09-19 (fused `assistantfinal` prefix & duplicate final text observed) ‚Äì see ADR-0013i & tests `test_channel_isolation.py`
	- [ ] 1d Leak metrics: reasoning_leak_total, channel_merge_anomaly_total (B, P0) ‚Äì REOPENED (no metric for fused marker / duplicate final) ‚Äì metrics helpers in `core/metrics.py`
	- [ ] 1e Final text guard (no service/channel markers) + unit test (T, P0) ‚Äì REOPENED (fused textual residue `assistantfinal` slipped through) ‚Äì finalize sanitation to be extended

2. System & Developer Prompt Standardization
	- [x] 2a Dynamic system lines (knowledge cutoff, date, reasoning level, channel banner) (B)
	- [x] 2b System vs developer separation (B)
	- [ ] 2c Extended developer/tool roles pipeline (B, P2)

3. Commentary Channel Enablement
	- [x] 3a Commentary parsing + retention summary modes (B/T)
	- [ ] 3b UI commentary/dev trace visibility (U, P1)

4. Return Token Normalization
	- [x] 4a `<|return|>` normalization + flag (B/T)

5. Reasoning Ratio Alert
	- [x] 5a Backend metric + threshold logic (B/T)
	- [x] 5b UI badge & tooltip (config-based threshold) (U, P1) ‚Äì implemented (contract test pending)
	- [ ] 5c Contract test: badge above threshold only (T, P1)

6. Cancellation Semantics
	- [x] 6a Abort events + KPI latency test (B/T)
	- [x] 6b UI cancelled state (badge + spinner removal + late label) (U, P1) ‚Äì implemented (contract test pending)

7. Sampling & Max Token Cap
	- [x] 7a Cap logic + metrics (`model_cap_hits_total`) (B/T)
	- [x] 7b ReasoningPresetApplied & user override tagging (B)
	- [x] 7c Limits exposure (/models) (B)
	- [x] 7d Baseline UI clamp & limit display (U)
	- [x] 7e Cap UX progress bar + CAP badge (U, P1)
	- [ ] 7f Contract test: CAP badge when cap_applied (T, P1)

8. Tool Calling Foundations
	- [x] 8a Header parsing (recipient/to, `<|constrain|>` stub) (B)
	- [x] 8b ToolCallPlanned / ToolCallResult events (B/T)
	- [x] 8c Final delta flush consistency (adapter) (B)
	- [ ] 8d Dev trace stub "No tool calls" (U, P1)
	- [ ] 8e Contract test: stub on zero tool calls (T, P1)

9. Retention & Privacy Safeguards
	- [x] 9a Retention modes + override metrics (B/T)
	- [ ] 9b Reasoning exclusion enforcement (no analysis in final_text) (B, P0) ‚Äì REOPENED (placeholder shown without any reasoning; UX contract incomplete: must suppress placeholder until first reasoning token OR mark 'none')
	- [x] 9c History guard test (no analysis markers persisted) (T, P0) ‚Äì `test_history_guard.py`

10. Unexpected Order Handling
	- [x] 10a Metric `harmony_unexpected_order_total` + tests (B/T)
	- [ ] 10b UI dev indicator (U, P2)

11. Performance & Stability
	- [x] 11a Perf smoke snapshot (decode_tps baseline) (B/T)
	- [x] 11b Regression guard (`PerfRegressionSuspect`) (B/T)
	- [x] 11c first_token_latency capture + SSE field (B, P1)
	- [x] 11d UI perf panel first_token_latency (U, P1)
	- [ ] 11e Contract test: first_token_latency format (T, P1)

12. RAG Skeleton
	- [ ] 12a Store interface (put/query/delete/stats) (B, P2)
	- [ ] 12b Events: DocumentIngested / DocumentIndexed / QueryExecuted (B, P2)
	- [ ] 12c In-memory vector stub + cosine unit test (B/T, P2)

13. Governance & ADR Coverage
	- [x] 13a ADR-UNEXPECTED-ORDER (G)
	- [x] 13b ADR-TOOL-CALLING-SCOPE (G)
	- [x] 13c ADR-COMMENTARY-RETENTION (G)
	- [ ] 13d Consolidated changelog (cap & cancellation semantics) (G, P1)
	- [x] 13e ADR: SSE meta frame + late-cancel backstop (G)
	- [x] 13f Pipeline extraction phase 1 (ADR-0026) (G)
	- [x] 13g ADR-0027 Metrics Snapshot Legacy Compatibility (G)
	- [x] 13h ADR-0028 Pipeline Finalize Extraction (G)
	- [x] 13i ADR: Harmony Channel Separation v2 (G, P0) ‚Äì ADR-0013i
	- [ ] 13j ADR: SSE warning frame format (ModelPassportMismatch) (G, P1)
	- [ ] 13k Config bi-directional test: reasoning ratio threshold (T/G, P1)

## Invariants (Authoritative)
Key | Invariant | Linked Plan | Severity
----|-----------|-------------|---------
INV-CH-ISO | Reasoning and final never mixed in final_text | 1c,1e,9b | P0
INV-LEAK-METRICS | Any leak -> leak metrics emitted | 1d | P0
INV-RATIO-VIS | UI ratio alert visible over threshold | 5b,5c | P1
INV-CAP-UX | Cap progress & badge visible | 7e,7f | P1
INV-CANCEL-CLAR | Cancelled visibly distinct | 6b | P1
INV-TOOL-TRACE | Tool absence explicit | 8d,8e | P1
INV-FIRST-TOKEN | first_token_latency surfaced (backend+UI done; test pending) | 11c,11d,11e | P1
INV-RAG-MIN | RAG skeleton contract present | 12a,12b,12c | P2
INV-GOV-ADR | Public contracts require ADR | 13i,13j | P0/P1
INV-CONFIG-BIDIR | Config threshold round-trip tested | 13k | P1

## KPIs (Phase 3 Monitored)
- p95 first load primary < 4s
- 0 unknown config keys / 0 required removed
- Reasoning leak heuristic = 0
- Ratio alert tests flake < 1%
- Cancel end-to-end latency (UI click‚ÜíSSE end) < 300ms


## Backlog (Consolidated ‚Äì –≤–Ω–µ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ SSOT –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
- Adaptive max_output_tokens heuristic (prompt length aware)
- PhiAdapter capability split (pass-through optimization)
- Full RAG production pipeline & retention policies
- Perf regression guard v2 (multi-model matrix)
- Advanced sampling normalization A/B (temperature standardization)
- Presence / Frequency penalties support
- Persona length indicators & persona editor UX
- UI deterministic badge (temperature ‚â§0.15 & top_p ‚â§0.85)
- Context length truncate strategy UI
- n_threads / n_batch UI controls
- Editable temperature/top_p (post preset sync) ‚Äì if deferred beyond current sprint
- Tool chain retention advanced rules
 - system_prompt_version + hash –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI

## Report Format (Unchanged)
–î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏: Summary / Tests / Metrics deltas / Risks (‚â§6 —Å—Ç—Ä–æ–∫).

---
–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∏ –∞—Ä—Ö–∏–≤–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ (–º–∞—Ä–∫–µ—Ä–Ω—ã–π —Ä–µ–∂–∏–º, –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ª–æ–≥–∏, —É–∂–µ —Ä–µ—à—ë–Ω–Ω—ã–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã) —É–¥–∞–ª–µ–Ω—ã –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —à—É–º–∞. –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ git history –∏ ADR –∞—Ä—Ö–∏–≤–∞—Ö.

## Appendix: –°–æ–∫—Ä–∞—â—ë–Ω–Ω—ã–π –ø–µ—Ä–µ—á–µ–Ω—å –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç |
|-----------|-----------|
| Config | –ù–æ–≤—ã–µ –∫–ª—é—á–∏ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `Config-Registry.md` + ADR |
| Errors | –¢–æ–ª—å–∫–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ enum codes |
| Streaming | Reasoning –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ history –ø—Ä–∏ drop_from_history=true |
| Metrics | –ö–∞–∂–¥–æ–µ fallback/parse_error/cap —Å–æ–±—ã—Ç–∏–µ ‚Üí –º–µ—Ç—Ä–∏–∫–∞ |
| Tests | –ü—É–±–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –±–µ–∑ —Ç–µ—Å—Ç–∞ –∑–∞–ø—Ä–µ—â—ë–Ω |
| Security | –ù–µ—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤/PII –≤ –ª–æ–≥–∞—Ö |
| RAG | –í—Å–µ –∑–∞–ø–∏—Å–∏ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º—ã –∏ —É–¥–∞–ª—è–µ–º—ã (–Ω–∏–∫–∞–∫–∏—Ö opaque blobs) |

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ grep –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ merge
1. `grep -R "MIA_LLAMA_FAKE"` ‚Üí –ø—É—Å—Ç–æ.
2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å—Ç—Ä–æ–∫ `final_marker` / `===FINAL===` –≤–Ω–µ –∞—Ä—Ö–∏–≤–Ω—ã—Ö ADR.
3. –ù–µ—Ç `TODO:` –±–µ–∑ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–µ–≥–æ issue/ADR –Ω–æ–º–µ—Ä–∞.

---
–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-09-30 (R3 fused sanitation metric, R6 UI guard, R8 reasoning-none —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è –∑–∞–∫—Ä—ã—Ç—ã; guard –æ—Å—Ç–∞—ë—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–º –¥–æ P1/monitoring). –ü—Ä–µ–¥—ã–¥—É—â–µ–µ: UI reasoning ratio badge, CAP progress bar & badge, CANCELLED badge UX, first_token_latency_ms backend —Å–±–æ—Ä + SSE –ø–æ–ª–µ + UI –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ; finalize sanitation guard –≤ `HarmonyChannelAdapter.finalize()` + leak reasons `service_marker_in_final`, `finalize_sanitize`). –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞ reasoning –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö max_output_tokens —Ä–∞–Ω–µ–µ mitigated; —Ä–∞—Å—à–∏—Ä–∏—Ç—å scrub –¥–ª—è fused –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤.

### 2025-09-19 Harmony Remediation (Fused Marker & Reasoning UX)
Scope: —É—Å—Ç—Ä–∞–Ω–∏—Ç—å —Å–ª–∏—Ç—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ (`assistantfinal` / –ø–æ–≤—Ç–æ—Ä), –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏ —à—É–º–Ω—ã–π reasoning placeholder.

Planned Tasks (R-prefix = remediation):
R1 (B) Fused prefix sanitation: –≤ –∞–¥–∞–ø—Ç–µ—Ä–µ —É–¥–∞–ª–∏—Ç—å –≤–µ–¥—É—â–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω—ã `^(assistantfinal|assistant final|assistant\s*final)+` (–¥–æ 3 –∏—Ç–µ—Ä–∞—Ü–∏–π); trim; –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ ‚Üí –º–µ—Ç—Ä–∏–∫–∞ `reasoning_leak_total{reason="fused_marker_prefix"}`.
R2 (B) Duplicate final suppression: –µ—Å–ª–∏ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö final —Ç–æ–∫–µ–Ω–æ–≤ == —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–∞–¥—Ä–∞ ‚Äì –Ω–µ –∑–∞–º–µ–Ω—è—Ç—å / –Ω–µ —É–¥–≤–∞–∏–≤–∞—Ç—å; leak metric `reasoning_leak_total{reason="duplicate_final"}`.
R3 (B) –î–æ–ø. counter `fused_marker_sanitizations_total` –≤ `core.metrics` (–∏–ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π leak counter label).
	- ‚úÖ 2025-09-30 remediation: –¥–æ–±–∞–≤–ª–µ–Ω helper `inc_fused_marker_sanitization(kind)` + unit –≤ `test_harmony_fused_sanitation.py`; –º–µ—Ç—Ä–∏–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç prefix/residue –ø—É—Ç–∏.
R4 (T) Backend tests: `test_harmony_fused_sanitation.py` (cases: fused prefix single, multiple, already clean) + duplicate suppression test.
	- ‚ö†Ô∏è 2025-09-30: fused prefix/residue paths covered; duplicate-final regression test still pending (awaiting server guard wiring).
R5 (U) Reasoning UX: –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–ª–æ–∫ –¥–æ –ø–µ—Ä–≤–æ–≥–æ reasoning —Å–æ–±—ã—Ç–∏—è; –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏ –Ω—É–ª–µ–≤–æ–≥–æ reasoning ‚Äì –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å —è–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å `reasoning: none` (dev mode) –≤ perf –ø–∞–Ω–µ–ª–∏ –∏–ª–∏ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–π –º–µ—Ç–∫–µ.
	- ‚è≥ –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: dev UI –≤—Å—ë –µ—â—ë –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç placeholder; —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–∏–∑–∞–π–Ω –∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏.
R6 (U) Defensive UI scrub: –≤—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª—è—Ç—å –≤–µ–¥—É—â–∏–µ `assistantfinal` *–¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–π —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —Ñ–∏–∫—Å–∞—Ü–∏–∏* (–±—É–¥–µ—Ç –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ removable guard).
	- ‚úÖ 2025-09-30 remediation: `AIMessage` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `sanitizeFinalText()` + UI –∫–æ–Ω—Ç—Ä–∞–∫—Ç —Ç–µ—Å—Ç `final_message_sanitization.spec.tsx` –æ–±–Ω–æ–≤–ª—ë–Ω; –ø–æ–º–µ—Ç–∏—Ç—å –æ—Ö—Ä–∞–Ω—É –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—É—é.
R7 (U/T) Update `final_message_sanitization.spec` –Ω–∞ fused prefix —Å—Ü–µ–Ω–∞—Ä–∏–π + –Ω–æ–≤—ã–π `reasoning_none.spec`.
	- ‚ö†Ô∏è Fused-prefix —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–∫—Ä—ã—Ç; –æ—Ç–¥–µ–ª—å–Ω—ã–π `reasoning_none` spec –æ—Å—Ç–∞—ë—Ç—Å—è TODO.
R8 (B) Telemetry event: `ReasoningSuppressedOrNone` {reason=[no-analysis-channel|budget-0]} –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –±–µ–∑ reasoning.
	- ‚úÖ 2025-09-30 remediation: `HarmonyChannelAdapter` —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ—Ç `set_context()` –∏–∑ `PrimaryPipeline`, unit `test_reasoning_none_telemetry.py` –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ + `reasoning_none_total`.
R9 (G) Changelog entry + ADR addendum "Harmony Fused Marker Remediation" (–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã, —Ç–µ—Å—Ç-–º–∞—Ç—Ä–∏—Ü–∞).
	- ‚úÖ 2025-09-30 remediation: changelog `2025-09-30-harmony-remediation-r3-r8.md` –∏ ADR-0013i addendum –æ–±–Ω–æ–≤–ª–µ–Ω—ã; –æ—Ç—Ä–∞–∂–µ–Ω—ã –Ω–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ UI guard.
R10 (T) SSE contract test: final frame –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `assistantfinal`; –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ ‚Äì —Ç–µ—Å—Ç –ø–∞–¥–∞–µ—Ç.
	- ‚è≥ –ù—É–∂–µ–Ω API/stream –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ç–µ—Å—Ç (–ø–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç); –∑–∞–≤–µ—Å—Ç–∏ –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –∞–¥–∞–ø—Ç–µ—Ä–∞.
R11 (G) Update invariant INV-CH-ISO: –≤–∫–ª—é—á–∏—Ç—å —è–≤–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è fused textual residues (–Ω–µ —Ç–æ–ª—å–∫–æ raw markers).
	- ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ –æ—Ç—Ä–∞–∂–µ–Ω–æ –≤ —Ä–∞–∑–¥–µ–ª–µ ‚ôª –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤; —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–µ ADR/registry –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è.
R12 (QA) Full test run (core + api + ui) + metrics snapshot diff; ensure no regression decode_tps > baseline -5%.
	- ‚ö†Ô∏è 2025-09-30: –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Ç–∞—Ä–≥–µ—Ç–Ω—ã–µ pytest + Vitest –ø–∞–∫–µ—Ç—ã; –ø–æ–ª–Ω—ã–π –ø—Ä–æ–≥–æ–Ω (api/perf/ui end-to-end) –∏ —Å–≤–µ–∂–∏–π metrics snapshot –µ—â—ë –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å.

Acceptance Criteria Summary:
- –ù–∏ –æ–¥–∏–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π SSE –∫–∞–¥—Ä –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç leading fused –ø—Ä–µ—Ñ–∏–∫—Å–∞.
- `reasoning_leak_total` –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ sanitation fused –∏–ª–∏ duplicate suppression.
- UI –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—É—Å—Ç–æ–π reasoning placeholder; –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ reasoning –µ—Å—Ç—å —è–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å.
- UI —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—É–∑—ã—Ä—å –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –∏ –±–µ–∑ `assistantfinal` –ø–æ–¥—Å—Ç—Ä–æ–∫–∏.
- –í—Å–µ –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è / –º–µ—Ç—Ä–∏–∫–∏ –æ—Ç—Ä–∞–∂–µ–Ω—ã –≤ docs (ADR + changelog) –∏ –∏–º–µ—é—Ç unit + –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ç–µ—Å—Ç.

Risk Notes:
- Over-sanitization (false positive) ‚Üí –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–µ–¥—É—â–∏–π –ø—Ä–µ—Ñ–∏–∫—Å –∏ –º–∞–∫—Å–∏–º—É–º 3 –∏—Ç–µ—Ä–∞—Ü–∏–∏.
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ duplicate final –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ –ø—Ä–æ–ø—É—Å–∫—É —Ä–µ–∞–ª—å–Ω–æ–≥–æ –¥–æ-–ø–æ—Ç–æ—á–Ω–æ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è (–ª–æ–≥–∏—Ä—É–µ–º debug –ø—Ä–∏ MIA_HARMONY_DEBUG=1).

### 2025-09-30 SSOT Alignment Snapshot

- ‚úÖ **Channel Separation Core**: `HarmonyChannelAdapter` —Ä–µ–∞–ª–∏–∑—É–µ—Ç per-channel –±—É—Ñ–µ—Ä—ã, sanitation, leak –º–µ—Ç—Ä–∏–∫–∏ ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç Harmony SSOT (analysis/commentary/final –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã).
- ‚úÖ **Observability First**: –ú–µ—Ç—Ä–∏–∫–∏ `reasoning_none_total`, `fused_marker_sanitizations_total`, `channel_merge_anomaly_total` –∏ events `ReasoningSuppressedOrNone` –∞–∫—Ç–∏–≤–Ω—ã; docs/ADR/changelog —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.
- ‚ö†Ô∏è **Contract Coverage Gaps**: SSE —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∫–∞–¥—Ä—ã –∏ reasoning-none UI –∫–æ–Ω—Ç—Ä–∞–∫—Ç –µ—â—ë –±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤ (R10, R5/R7 pending) ‚Äî –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–∞–∑–¥–µ–ª—É SSOT –ø—Ä–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã.
- ‚ö†Ô∏è **Governance Follow-through**: INV-CH-ISO —Ñ–æ—Ä–º–∞–ª—å–Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω –≤ ADR registry; SSOT —Ç—Ä–µ–±—É–µ—Ç –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã ‚Äî –∑–∞–¥–∞—á—É –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –±–ª–∏–∂–∞–π—à–∏–π Governance —Å–ø—Ä–∏–Ω—Ç.
- üöß **RAG Skeleton**: –ü–ª–∞–Ω Execution 12a‚Äì12c –æ—Å—Ç–∞—ë—Ç—Å—è –ø—É—Å—Ç—ã–º; SSOT Harmony –ø—Ä–µ–¥–ø–∏—Å—ã–≤–∞–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å RAG –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è.
- üîç **Full-suite Validation**: –¢–æ–ª—å–∫–æ —Ç–∞—Ä–≥–µ—Ç–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≥–Ω–∞–Ω—ã; SSOT baseline –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –ø–æ–ª–Ω—ã–π –ø—Ä–æ–≥–æ–Ω + metrics snapshot (R12 open).

## –ò–∑–º–µ–Ω–µ–Ω–∏—è 2025-09-16 (P0 Remediation Wave)

### ‚úÖ –ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ, –Ω–µ —Ä–µ—à–∞—é—â–∏–µ –∫–æ—Ä-–ø—Ä–æ–±–ª–µ–º—É):
1. **DevContext —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** ‚Äì event listener 'mia-dev-change' (OK)
2. **Reasoning —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è (UI)** ‚Äì —Ñ—É–Ω–∫—Ü–∏—è sanitizeReasoning() (–≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ä–∞, –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ)
3. **Reasoning placeholder** ‚Äì "reasoning (waiting...)" üîÑ –≤ dev-—Ä–µ–∂–∏–º–µ
4. **–¢–µ—Å—Ç—ã —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏** ‚Äì test_reasoning_sanitization.py (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –æ—Ö–≤–∞—Ç, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω—ã–π leak)

### üöß P0 Remediation (–¢–µ–∫—É—â–∏–π —Å–ø—Ä–∏–Ω—Ç ‚Äì –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–æ –ª—é–±—ã—Ö P1/P2):
P0 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–∞–º Streaming (–∑–∞–ø—Ä–µ—â–µ–Ω–æ —Å–º–µ—à–µ–Ω–∏–µ reasoning –∏ final) –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫.

1. Server: HarmonyChannelAdapter v2
	- –ü–µ—Ä-–∫–∞–Ω–∞–ª—å–Ω—ã–µ –±—É—Ñ–µ—Ä—ã: analysis / commentary / final
	- –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ –î–û —ç–º–∏—Å—Å–∏–∏ —Å–æ–±—ã—Ç–∏–π
	- –ó–∞–ø—Ä–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å–ª–µ final (—É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ –µ—Å—Ç—å, —É—Å–∏–ª–∏—Ç—å –∫–∞–Ω–∞–ª-–≥–≤–∞—Ä–¥—ã)
	- –ú–µ—Ç—Ä–∏–∫–∞: reasoning_leak_total{reason}
	- –ú–µ—Ç—Ä–∏–∫–∞: channel_merge_anomaly_total (–ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ analysis —Ç–æ–∫–µ–Ω–∞ –≤ final —Ñ—Ä–µ–π–º–µ)
	- Assertion: –ø—Ä–∏ finalize final_text –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç Harmony –º–∞—Ä–∫–µ—Ä–æ–≤ / analysis —Ç–æ–∫–µ–Ω–æ–≤
2. Stream Route Integration
	- SSE: –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è analysis (–Ω–µ –ø–∏—à—É—Ç—Å—è –≤ history)
	- final —Ç–æ–ª—å–∫–æ –∏–∑ delta —Ç–∏–ø–∞ "delta" / "final"; –Ω–∏–∫–∞–∫–∏—Ö analysis —Ç–æ–∫–µ–Ω–æ–≤ –≤ ctx.fragments
3. History Guard
	- –ü—Ä–∏ append assistant —Å–æ–æ–±—â–µ–Ω–∏—è: –≤–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å–ª—É–∂–µ–±–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
4. Contract Tests
	- SSE –ø–æ—Ç–æ–∫: final —Å–µ–≥–º–µ–Ω—Ç—ã –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç 'analysis|', '<|channel|>analysis', –∏–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ —Å–µ—Ä–≤–∏—Å–∞
	- –ò–Ω—ä–µ–∫—Ü–∏—è –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–º–µ—à–µ–Ω–∏—è ‚Üí leak –º–µ—Ç—Ä–∏–∫–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è
5. UI Consumer Update
	- –†–∞–∑–¥–µ–ª—å–Ω—ã–µ –±—É—Ñ–µ—Ä—ã: reasoningBuffer vs finalBuffer
	- Collapsible reasoning –±–ª–æ–∫; —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–µ–π (—Å–µ—Ä–≤–µ—Ä —É–∂–µ —á–∏—Å—Ç)
	- Placeholder "(model thinking‚Ä¶)" –¥–æ –ø–µ—Ä–≤–æ–≥–æ final —Ç–æ–∫–µ–Ω–∞
6. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è & ADR
	- ADR: Harmony Channel Separation v2 (–ø—Ä–æ–±–ª–µ–º–∞, —Ä–µ—à–µ–Ω–∏–µ, –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è, —Ç–µ—Å—Ç-–º–∞—Ç—Ä–∏—Ü–∞)
	- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ (SSOT) + Config-Registry –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ threshold –∫–ª—é—á–µ–π (–µ—Å–ª–∏ –ø–æ—è–≤—è—Ç—Å—è)

### üîú P1 (–ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è P0):
1. UX –ú–µ—Ç—Ä–∏–∫–∏ & –ë–µ–π–¥–∂–∏
	- Reasoning ratio alert badge (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ threshold, –±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞)
	- CAP badge + –ø—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä: Output Tokens used / effective_max_tokens
	- Cancelled badge/label –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
2. Perf –ü–∞–Ω–µ–ª—å
	- first_token_latency –≤—ã–≤–æ–¥ + –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ç–µ—Å—Ç —Ñ–æ—Ä–º–∞—Ç–∞
3. Tool Calls Dev Trace
	- Stub "No tool calls" –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ —Å–æ–±—ã—Ç–∏–π ToolCallPlanned/Result
4. SSE 'warning' frame —Ç–µ—Å—Ç + ADR —Ñ–∏–∫—Å–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ (ModelPassportMismatch)

### üß≠ P2 (Governance / Hardening):
1. Negative / Malformed Tests (unknown channel, interleaving after final)
2. Retention modes edge cases (override chain, hashed_slice truncation correctness)
3. Reasoning ratio threshold –∫–æ–Ω—Ñ–∏–≥ bi-directional —Ç–µ—Å—Ç
4. Perf regression —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ (multi-model matrix) ‚Äì –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ P0/P1

### üìå –ò—Å–∫–ª—é—á–µ–Ω–æ / –û—Ç–ª–æ–∂–µ–Ω–æ (–Ω–µ –≤ —Ç–µ–∫—É—â–µ–º —Å–ø—Ä–∏–Ω—Ç–µ):
- RAG production pipeline (–æ—Å—Ç–∞—ë—Ç—Å—è –≤ –æ–±—â–µ–º Execution Plan –ø.12)
- Advanced sampling normalization A/B
- Adaptive max_output_tokens heuristic

–í—Å–µ –±—É–¥—É—â–∏–µ –ø—É–Ω–∫—Ç—ã –¥–æ–ª–∂–Ω—ã —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ –æ–¥–∏–Ω SSOT‚Äì–±–ª–æ–∫ (—ç—Ç–æ—Ç —Ñ–∞–π–ª) –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∏–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö.

### üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ):
- `chatgpt-design-app/src/components/Chat/ChatWindow.tsx` ‚Äì reasoning buffer, ratio badge, CAP progress & badge, CANCELLED badge, first_token_latency_ms display
- `chatgpt-design-app/src/styles/globals.css` ‚Äì —Å—Ç–∏–ª–∏ –¥–ª—è ratio-alert, cap-progress, cancelled badge
- `chatgpt-design-app/src/api.ts` ‚Äì —Ä–∞—Å—à–∏—Ä–µ–Ω `UsageEvent` (cap_applied, effective_max_tokens, first_token_latency_ms)
- `tests/ui/test_cap_badge_placeholder.md` ‚Äì –ø–ª–∞–Ω –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ CAP
- `tests/ui/test_reasoning_ratio_badge_placeholder.md` ‚Äì –ø–ª–∞–Ω –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ ratio badge
- `tests/ui/test_cancelled_state_placeholder.md` ‚Äì –ø–ª–∞–Ω –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ cancelled UX
- `tests/ui/test_first_token_latency_placeholder.md` ‚Äì –ø–ª–∞–Ω –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ first token latency
- `chatgpt-design-app/package.json` ‚Äì –¥–æ–±–∞–≤–ª–µ–Ω —Å–∫—Ä–∏–ø—Ç `dev`
- (–†–∞–Ω–µ–µ) `chatgpt-design-app/src/components/Settings/SettingsPopover.tsx` ‚Äì dev mode events
- (–†–∞–Ω–µ–µ) `chatgpt-design-app/src/utils/reasoningSanitization.ts` ‚Äì legacy (–∫ —É–¥–∞–ª–µ–Ω–∏—é –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —á–∏—Å—Ç–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞)
- `tests/core/test_reasoning_sanitization.py` ‚Äì hygiene —Ç–µ—Å—Ç—ã
- `core/llm/adapters.py` ‚Äì finalize sanitation guard (service marker scrub, leak reasons `service_marker_in_final`, `finalize_sanitize`)
- `docs/API.md` ‚Äì –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `first_token_latency_ms` –≤ usage SSE

### üîÑ –û—Å—Ç–∞–≤—à–∏–µ—Å—è P1 –∑–∞–¥–∞—á–∏:
- Contract tests: reasoning ratio badge (5c), CAP badge (7f), cancelled badge (6b), first token latency (11e)
- Tool calls stub component (8d) + —Ç–µ—Å—Ç (8e)
- SSE warning frame ADR + —Ç–µ—Å—Ç (13j)

### üõ† –ù–æ–≤—ã–µ –≤—ã—è–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (2025-09-18 –ø–æ—Å—Ç-–ª–∞—É–Ω—á–µ—Ä / UI —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—É–∑—ã—Ä—å):
- [P0] –ò—Å–ø—Ä–∞–≤–∏—Ç—å —É—Ç–µ—á–∫—É —Å–ª—É–∂–µ–±–Ω—ã—Ö / channel –º–∞—Ä–∫–µ—Ä–æ–≤ –≤–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –ø—É–∑—ã—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç `analysis` –∏ `<|start|>assistant|channel|final|message|`).
	- –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: —Å–≤–µ—Ä–∏—Ç—å SSE final payload vs –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ UI.
	- –ò—Å–ø—Ä–∞–≤–∏—Ç—å: UI –¥–æ–ª–∂–µ–Ω —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ `finalText`; reasoning / —Å–ª—É–∂–µ–±–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã —Ç–æ–ª—å–∫–æ –≤ —Å–≤–µ—Ä–Ω—É—Ç–æ–º reasoning –±–ª–æ–∫–µ.
	- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ç–µ—Å—Ç: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `<|channel|>` –∏ `<|start|>` –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —Ç–µ–∫—Å—Ç–µ.
- [P1] Smoke-—Ç–µ—Å—Ç –ª–∞—É–Ω—á–µ—Ä–∞ Windows: –∑–∞–ø—É—Å–∫ `scripts/launch/run_all.bat dev` —Å `MIA_NO_BROWSER=1` ‚Üí exit 0, –≤ –≤—ã–≤–æ–¥–µ –µ—Å—Ç—å `UI launch URL=` –∏ –Ω–µ—Ç `was unexpected at this time`.
- [P1] Grep guard –¥–ª—è –±–∞—Ç–Ω–∏–∫–∞: —Ç–µ—Å—Ç / —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –≥—Ä—É–ø–ø–∏—Ä—É—é—â–∏—Ö —Å–∫–æ–±–æ–∫ `if (` –≤ `scripts/launch/run_all.bat`.
- [P1] –ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ –ø—É–∑—ã—Ä—è ‚Äì —É–¥–∞–ª–∏—Ç—å legacy `reasoningSanitization.ts` (—Å–º. –æ—Ç–¥–µ–ª—å–Ω—É—é –∑–∞–¥–∞—á—É) –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–µ—Å—Ç, –æ–±–Ω–æ–≤–∏–≤ changelog.
- [P2] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π e2e HTML snapshot —Ç–µ—Å—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å—Ç–∏–ø–ª–æ–≤–∞–Ω–Ω—ã–π conversation ‚Üí snapshot –±–µ–∑ –º–∞—Ä–∫–µ—Ä–æ–≤).

### ‚ôª –î–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∫ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–∞–º:
- INV-CH-ISO —É—Ç–æ—á–Ω–µ–Ω–∏–µ: UI —Ä–µ–Ω–¥–µ—Ä —Ñ–∏–Ω–∞–ª–∞ –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ —Å–æ–±–∏—Ä–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–∑ —Å—ã—Ä—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤, —Ç–æ–ª—å–∫–æ –∏–∑ –æ—á–∏—â–µ–Ω–Ω–æ–≥–æ `finalText` backend.
- INV-LAUNCHER-STABLE: `scripts/launch/run_all.bat` –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –≥—Ä—É–ø–ø–∏—Ä—É—é—â–∏—Ö `(` –±–ª–æ–∫–æ–≤; –∫–æ–Ω—Ç—Ä–æ–ª—å —á–µ—Ä–µ–∑ grep —Ç–µ—Å—Ç.

## –ù–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (–≤ —Ä–∞–º–∫–∞—Ö –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –Ω–æ–≤–æ–º—É —á–∞—Ç—É)
- Launcher UX parity (.bat):
	- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ scripts/launch/*.bat –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å:
		- dev —Ä–µ–∂–∏–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ (dev_pre_stream_delay_ms / dev_per_token_delay_ms).
		- –ø–∞–Ω–µ–ª—å –º–µ—Ç—Ä–∏–∫ (latency, decode_tps, context_used_pct, reasoning_ratio).
		- —Å–≤–µ—Ä–Ω—É—Ç—ã–π reasoning –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å–∫—Ä—ã—Ç—å).
	- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏: –≤–∫–ª—é—á–∏—Ç—å —Ñ–ª–∞–≥–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ dev –∑–∞–ø—É—Å–∫–µ, –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ UI, –æ–±–Ω–æ–≤–∏—Ç—å README –ø–æ –∑–∞–ø—É—Å–∫—É.
- ADR + –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è SSE 'warning' —Ñ—Ä–µ–π–º–∞:
	- –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç —Å–æ–±—ã—Ç–∏—è (event: 'warning', payload.event='ModelPassportMismatch', –ø–æ–ª—è).
	- –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç API, –ø—Ä–æ–≤–µ—Ä—è—é—â–∏–π –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ warning –ø—Ä–∏ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞ –∏ –∫–æ–Ω—Ñ–∏–≥–∞.

<!-- Harmony 10.x full compliance checklist removed: history captured in changelog harmony files -->
**Historical Harmony implementation details:** —Å–º. `docs/changelog/*harmony*` (stage1, ratio alert, system/dev split, commentary, cancellation, return normalization).
